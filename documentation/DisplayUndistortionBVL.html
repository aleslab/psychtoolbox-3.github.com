<h2 id="psychtoolbox-psychglimageprocessing">[[Psychtoolbox]] › [[PsychGLImageProcessing]]</h2>
<p>[scal] = <a href="DisplayUndistortionBVL" class="uri">DisplayUndistortionBVL</a>([caliboutfilename][, screenid][, xnum=37][, ynum=27][, referenceImage=None][, stereomode=0])<br />
[scal] = <a href="DisplayUndistortionBVL" class="uri">DisplayUndistortionBVL</a>([caliboutfilename][, calibinfilename])</p>
<p>Geometric display calibration procedure for undistortion of distorted<br />
displays. Needs graphics hardware with basic support for the PTB imaging<br />
pipeline (see below).</p>
<p>This code was contributed by the members of the Banks Vision Lab at<br />
University of California, Berkeley. It is a subset of their internal<br />
“BVL” library and used since many years for their display devices,<br />
haploscopes etc., so it should be reasonably bug-free and mature.</p>
<p>Many display devices, e.g., video beamers and most CRT displays cause<br />
some amount of spatial distortion to your visual stimuli during display.<br />
Psychtoolbox can “undistort” your visual stimuli for you: At stimulus<br />
onset time, PTB applies a geometric warping transformation to your<br />
stimulus which is meant to counteract or cancel out the geometric<br />
distortion caused by your display device. If both, PTB’s warp transform<br />
and the implicit distortion transform of the display match, your stimulus<br />
will show up undistorted on the display device.</p>
<h3 id="for-this-to-work-ptb-needs-two-things">For this to work, PTB needs two things:</h3>
<ol type="1">
<li><p>Recent graphics hardware with support for the PTB imaging pipeline:<br />
See our Wiki for recommendations. However, all ATI cards starting with<br />
Radeon 9500 and all <a href="NVidia" class="uri">NVidia</a> cards of type <a href="GeForce" class="uri">GeForce</a>-FX5200 and later, as<br />
well as the Intel-GMA 950 and later should be able to do it, although<br />
more recent cards will have a higher performance.</p></li>
<li><p>A calibration file that defines the warp transformation to apply. Your<br />
experiment script will load that file into <a href="Screen" class="uri">Screen</a>’s “warp engine” at the<br />
beginning of your experiment.</p></li>
</ol>
<p>This routine allows you to create such a calibration file in an<br />
interactive procedure: You can change and tweak the transformation until<br />
it fits your needs, ie. until it nicely undistorts your display. Then the<br />
corresponding calibration file is saved for later use with that display.</p>
<p><a href="DisplayUndistortionBVL" class="uri">DisplayUndistortionBVL</a> defines a continous mapping (x’, y’) = f(x, y)<br />
from uncorrected input pixel locations (x,y) in your stimulus image to<br />
output locations (x’, y’) on your display. This mapping is defined by a<br />
3rd order, 2-dimensional polynomial that is fitted to the calibration data.</p>
<h3 id="how-to-use">How to use:</h3>
<ol type="1">
<li>Start the script, providing all parameters that you don’t want to have<br />
at default settings (all parameters have reasonable defaults):</li>
</ol>
<p>‘caliboutfilename’ Name of the file to which calibration results should<br />
be stored. If no name is provided, the file will be stored inside the<br />
‘GeometryCalibration’ subfolder of your psychtoolbox configuration<br />
directory (path is <a href="PsychToolboxConfigDir" class="uri">PsychToolboxConfigDir</a>(‘GeometryCalibration’). The<br />
filename will contain the screenid and resolution of the display that was<br />
calibrated.</p>
<p>‘calibinfilename’ is the optional path and filename of an existing<br />
calibration file that you want to use as a template or starting point for<br />
your calibration, e.g., from previous calibrations in order to save you<br />
some setup work. If no ‘calibinfilename’ is provided or if ‘screenid’ and<br />
other parameters are provided instead, the script will start with a<br />
default rectilinear calibration grid of equally spaced points.</p>
<h3 id="these-parameters-only-have-meaning-if-no-calibinfilename-was-provided">These parameters only have meaning if no ‘calibinfilename’ was provided:</h3>
<p>‘screenid’ screen id of the target display for calibration. If<br />
‘calibinfilename’ was provided, the screenid encoded in that file will be<br />
used. Otherwise, the provided screenid will be used. If this parameter is<br />
omitted, PTB will use the single screen on a single display setup. On a<br />
multi-display setup, PTB will ask for the screenid.</p>
<p>‘xnum’ and ‘ynum’ Optional number of horizontal and vertical calibration<br />
points to use. Their number doesn’t affect runtime behaviour of your<br />
stimulus script, only the quality of your calibration and the amount of<br />
time you’ll need to calibrate. The default settings are xnum = 37 and<br />
ynum = 27. ‘xnum’ and ‘ynum’ should be odd numbers. If you provide an<br />
even number it will be rounded up to the next odd number.</p>
<p>‘referenceImage’ Optional name of an image file in a format supported by<br />
Matlab/Octaves imread() command: If provided, the image will be loaded<br />
from filesystem and drawn as a backdrop to the calibration grid. You can<br />
use this if you want to use this routine not to undistort a physical<br />
display, but want to undistort an existing image, e.g., create a proper<br />
calibration file for the <a href="ImageUndistortionDemo" class="uri">ImageUndistortionDemo</a> routine.</p>
<p>‘stereomode’ Optional stereo mode for display of calibration. Defaults to<br />
zero, i.e., monoscopic display.</p>
<ol start="2" type="1">
<li>After startup, the script will display a grid of mostly evenly spaced<br />
points onscreen. The points will not be perfectly aligned to a grid due<br />
to the distortion caused by your display. Your job is to tweak and shift<br />
those points so that they line up to a rectilinear grid as good as<br />
possible on your display from the viewpoint of your subject.</li>
</ol>
<p>The best way to do this is to build a real mechanical rectilinear grid of<br />
fine wires and mount it to your display as a “real world” reference for a<br />
perfect grid. Then you move the displayed calibration dots so that they<br />
perfectly align with the crossings of the horizontal- and vertical wires<br />
of your mechanical reference grid.</p>
<h3 id="mouse-operation">Mouse operation:</h3>
<p>In ‘global mode’ (when you see the hair-cross in the center of the<br />
screen), the mouse buttons do the following:</p>
<p>‘Left mouse’ or ‘l’ key: Switch to local mode.<br />
‘Middle mouse’ or ‘m’ key: Change stepsize for parameter adjustments.<br />
‘Right mouse’ or ‘r’ key: Change type of parameter to adjust.</p>
<p>Following global parameters can be adjusted in global mode:<br />
‘Translation’ of whole dot field.<br />
‘<a href="Scale" class="uri">Scale</a>’ of dot field.<br />
‘Shear’ of dot field.<br />
‘Trapezoid’ correction.<br />
‘Barrel and pincusion’ distortion.</p>
<p>In ‘local mode’: The location of a selected dot or a selection of dots<br />
can be changed:</p>
<p>‘Left mouse’ + mouse drag: Select a single dot close to mouse cursor, or<br />
draw a bounding rectangle around a region of<br />
dots to select.</p>
<p>‘Middle mouse’ or ‘m’ key: Change stepsize for translation of dot(s).<br />
‘Right mouse’ or ‘r’ key: Unselect dot(s) if dot(s) is/are selected.<br />
Switch to ‘global mode’ if no dot(s) selected.</p>
<h3 id="keys-and-their-meaning">Keys and their meaning:</h3>
<p>‘l’ ‘m’ and ‘r’ buttons are synonyms for left- middle- and right mouse<br />
buttons. However, its much more convenient to use a three button mouse.</p>
<p>Cursor arrow keys move selected dot(s) or change selected global<br />
parameters.</p>
<p>‘space’ key toggles the display of the online help text.</p>
<p>You finish the calibration and write it into a calibration file by<br />
pressing the <a href="ESCape" class="uri">ESCape</a> key. This will end the calibration script. The<br />
structure ‘scal’ which contains all calibration results will also be<br />
returned by this function as optional return argument.</p>
<p>This script will print out a little snippet of code that you can paste<br />
and include into your experiment script - That will automatically load<br />
the calibration result file and apply the proper undistortion operation.</p>
<div class="code_header" style="text-align:right;">
<p><span style="float:left;">Path  </span> <span class="counter">Retrieve <a href=
  "https://raw.github.com/Psychtoolbox-3/Psychtoolbox-3/beta/Psychtoolbox/PsychGLImageProcessing/DisplayUndistortionBVL.m">current version from GitHub</a> | View <a href=
  "https://github.com/Psychtoolbox-3/Psychtoolbox-3/commits/beta/Psychtoolbox/PsychGLImageProcessing/DisplayUndistortionBVL.m">changelog</a></span></p>
</div>
<div class="code">
<p><code>Psychtoolbox/PsychGLImageProcessing/DisplayUndistortionBVL.m</code></p>
</div>
