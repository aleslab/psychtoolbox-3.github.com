<h2 id="psychtoolbox-psychdocumentation">[[Psychtoolbox]] › [[PsychDocumentation]]</h2>
<p><a href="BeampositionQueries" class="uri">BeampositionQueries</a> – What they are used for, and what can go wrong.</p>
<p>GNU/Linux, <a href="MacOS" class="uri">MacOS</a>-X and MS-Windows provide a mechanism that allows to<br />
query the scanline which is currently updated by the scanning beam of a<br />
CRT display or by the equivalent mechanism in a video beamer or flat<br />
panel display, the so called “beamposition”.</p>
<h3 id="we-use-this-mechanism-for-two-purposes">We use this mechanism for two purposes:</h3>
<ol type="1">
<li>Independent measurement of the monitor refresh interval: Psychtoolbox<br />
executes a measurement loop during <a href="Screen" class="uri">Screen</a>(‘OpenWindow’) where it determines<br />
the monitor refresh interval. It takes a timestamp whenever the beamposition<br />
resets to zero at the start of a new display refresh cycle. The difference<br />
between consecutive timestamps is a sample of refresh duration. The samples<br />
of 50 consecutive refresh cycles are averaged. The “length” of the VBL<br />
is also computed as the difference between screen height (e.g., 1024 at a<br />
display resolution of 1280 x 1024 pixels) and the highest scanline value<br />
encountered during the 50 refresh cycles.</li>
</ol>
<p>This measurement is used to cross-check the results of the synchronization tests<br />
(see ‘help SyncTrouble’) and the value provided by the operating system to<br />
make the sync tests and display calibration as robust as possible, even<br />
if the operating system reports bogus values like 0 Hz, which can happen<br />
on <a href="MacOS" class="uri">MacOS</a>-X and Windows with some flat panels.</p>
<ol start="2" type="1">
<li>Highly accurate and robust stimulus onset timestamps in <a href="Screen" class="uri">Screen</a>(‘<a href="Flip" class="uri">Flip</a>’).</li>
</ol>
<p>In normal operation, the <a href="Screen" class="uri">Screen</a>(‘<a href="Flip" class="uri">Flip</a>’) command, after issuing a buffer-swap<br />
request to the gfx-hardware, pauses execution until the operating system<br />
signals swap-completion in sync with vertical retrace. Then it takes a high-<br />
precision system timestamp. Due to the scheduling jitter present in any<br />
operating system, sometimes the execution of Psychtoolbox is resumed only after<br />
some random multi-millisecond delay has passed after buffer-swap, so the<br />
stimulus onset timestamp can be possibly off by multiple milliseconds from<br />
the real stimulus onset time. This is unwanted timing noise, especially if<br />
the time stamp is to be used for either computing stimulus onset time for<br />
future stimuli, or for synchronizing Psychtoolbox execution with other<br />
stimulus generators or acquisition hardware.</p>
<p>On Microsoft Windows 2000 and later, Beamposition timestamping is fully<br />
supported.</p>
<p>On GNU/Linux, timing precision even in non-realtime scheduling mode is<br />
far superior to all other operating systems, yielding a timing jitter of<br />
less than 100 microseconds under normal operating conditions. For special<br />
needs, there exist multiple methods of improving timing down to<br />
microsecond level, although some of time require some advanced<br />
programming skills. If Psychtoolbox runs on any recent AMD/ATI, or <a href="NVidia" class="uri">NVidia</a><br />
graphics card, it will utilize beamposition queries for even better<br />
timing precision. If your Linux system uses an open-source graphics<br />
driver for <a href="NVidia" class="uri">NVidia</a> (“nouveau”), AMD/ATI (“radeon”) or Intel GPU’s, as well<br />
as on various embedded GPU’s (Smartphones and Tablets, embedded systems<br />
etc.), Linux itself has a built-in high precision timestamping facility<br />
which is even more robust and precise than Psychtoolbox beamposition<br />
timestamping.</p>
<p>On <a href="MacOSX" class="uri">MacOSX</a> we use beamposition queries to improve accuracy of our timestamps<br />
with the help of the <a href="PsychtoolboxKernelDriver" class="uri">PsychtoolboxKernelDriver</a> (see “help <a href="PsychtoolboxKernelDriver" class="uri">PsychtoolboxKernelDriver</a>”)<br />
on cards from AMD and <a href="NVidia" class="uri">NVidia</a>. On Intel graphics cards, beamposition time-<br />
stamping doesn’t work by default. An alternative mechanism, based on vblank<br />
timestamps can be enabled by setting <a href="Screen" class="uri">Screen</a>(‘<a href="Preference" class="uri">Preference</a>’,‘VBLTimestampingmode’, 1);<br />
This is implemented at acceptable reliability and precision on OS/X 10.6,<br />
and will be used if the beamposition mechanism malfunctions or is unavailable.<br />
On 10.7 and later the rather unreliable and sometimes unstable <a href="CoreVideo" class="uri">CoreVideo</a><br />
timestamping can be enabled, at the risk of applications crashes and wrong<br />
results on some setups. We always strongly recommend installing the<br />
<a href="PsychtoolboxKernelDriver" class="uri">PsychtoolboxKernelDriver</a> for best results. Intel graphics cards on <a href="MacOSX" class="uri">MacOSX</a><br />
are problematic: Our <a href="PsychtoolboxkernelDriver" class="uri">PsychtoolboxkernelDriver</a> can’t handle them without the<br />
severe danger of causing a hard system crash, so don’t use a Intel graphics<br />
card if you need high precision visual stimulus onset timestamps or timing.</p>
<h3 id="this-is-how-beamposition-queries-are-used">This is how beamposition queries are used:</h3>
<p>When taking the system timestamp, we also query the current rasterbeam<br />
position. From the known height of the display (in scanlines, including<br />
height of VBL), and the known refresh interval of our display, we can<br />
translate the current beam position into “elapsed time since start of VBL<br />
== elapsed time since double buffer swap”. By subtracting this elapsed<br />
time value from our system timestamp, we get a corrected timestamp - the<br />
real system time of double buffer swap == start of VBL == aka stimulus<br />
onset. This allows for very accurate timestamps, despite possible<br />
non-deterministic multi-millisecond timing jitter. Psychtoolbox goes<br />
through great pains during startup to double-check that all required<br />
calibration values and mechanisms are accurate and working properly. You<br />
can assess the accuracy of all returned timestamps by use of the script<br />
<a href="VBLSyncTest" class="uri">VBLSyncTest</a>. A visual correctness test is provided by<br />
<a href="PerceptualVBLSyncTest" class="uri">PerceptualVBLSyncTest</a>. PTB also performs continuous runtime checking to<br />
detect possible problems caused by defective graphics card drivers.</p>
<p>In case that beamposition queries should not work properly or are not<br />
supported, PTB will use different fallback strategies:</p>
<p>On Microsoft Windows, only a normal - possibly noisy - timestamp is taken.</p>
<p>On <a href="MacOSX" class="uri">MacOSX</a> by default noisy timestamps are taken.<br />
On <a href="MacOSX" class="uri">MacOSX</a>, if you set <a href="Screen" class="uri">Screen</a>(‘<a href="Preference" class="uri">Preference</a>’,‘VBLTimestampingmode’, 1);<br />
PTB tries to use <a href="CoreVideo" class="uri">CoreVideo</a> <a href="CVDisplayLink" class="uri">CVDisplayLink</a> timestamps, and uses their<br />
values for timestamping the time of buffer- swap. The robustness,<br />
precision and correctness of <a href="CVDisplayLink" class="uri">CVDisplayLink</a> timestamps is not that great<br />
on 10.7 and later, therefore this fallback mechanism may be removed in a<br />
future PTB release. If these queries should fail as well, PTB falls back<br />
to pure timestamping without any correction.</p>
<p>To get best precision and reliability on OSX 10.7 and later we strongly<br />
recommend you install the <a href="PsychtoolboxKernelDriver" class="uri">PsychtoolboxKernelDriver</a> and use a <a href="NVidia" class="uri">NVidia</a> or<br />
AMD graphics card, not an Intel graphics card.</p>
<p>On Linux, built-in <a href="OpenML" class="uri">OpenML</a> timestamping has the highest priority,<br />
robustness and precision and is available on the open-source graphics<br />
drivers (intel, radeon, nouveau). Should that functionality be missing,<br />
because you installed the proprietary graphics drivers, beamposition<br />
timestamping is used on <a href="NVidia" class="uri">NVidia</a> and AMD/ATI with the proprietary graphics<br />
drivers, followed by the equivalent of kernel-level vbl timestamping<br />
should that fail as well for some reason, followed by uncorrected<br />
timestamping.</p>
<p>The behaviour of PTB can be controlled by the command:<br />
<a href="Screen" class="uri">Screen</a>(‘<a href="Preference" class="uri">Preference</a>’, ‘VBLTimestampingMode’, mode); where mode can be one of the<br />
following:</p>
<p>-1 = Disable all cleverness, take noisy timestamps. This is the behaviour<br />
you’d get from any other psychophysics toolkit, as far as we know.</p>
<p>0 = Disable <a href="CoreVideo" class="uri">CoreVideo</a>/kernel fallback method (OSX and Linux), use<br />
either beamposition stamps or noisy stamps if beamposition is<br />
unavailable. This is the effective default setting on OSX and Windows.</p>
<p>1 = Use beamposition. Should it fail, switch to use of kernel-level/<a href="CoreVideo" class="uri">CoreVideo</a><br />
timestamps. If that fails as well or is unavailable, use noisy<br />
stamps.</p>
<p>2 = Use beamposition, but cross-check with kernel-level/<a href="CoreVideo" class="uri">CoreVideo</a> timestamps.<br />
Use noisy stamps if beamposition mode fails. This is for the paranoid<br />
to check proper functioning.</p>
<p>3 = Always use kernel-level/<a href="CoreVideo" class="uri">CoreVideo</a> timestamping, fall back to noisy<br />
stamps if it fails.</p>
<p>4 = Use <a href="OpenML" class="uri">OpenML</a> OML_sync_control extension for high-precision timestamping<br />
on supported system configuration, fall back on beamposition queries<br />
if the <a href="OpenML" class="uri">OpenML</a> mechanism is unavailable. <a href="OpenML" class="uri">OpenML</a> timestamping is<br />
currently a Linux only feature on the free open-source graphics<br />
drivers. This is the default on Linux and Windows.</p>
<p>The effective default on OS-X and Windows is “0”, and “4” on Linux.</p>
<p>If the beamposition query test fails, you will see some warning message<br />
about “SYNCHRONIZATION TROUBLE” in the Matlab/Octave command window or<br />
other error messages, as diagnostics is performed at various stages of<br />
setup and operation.</p>
<h3 id="there-are-multiple-possible-causes-for-failure">There are multiple possible causes for failure:</h3>
<ol type="1">
<li><p>Running digital displays like flat panels or projectors at non-native<br />
resolution, ie., anything other than their rated maximum resolution, or<br />
using display rotation by 90/180/270 degrees, e.g., putting the display<br />
from landscape into portrait orientation. This will violate various<br />
assumptions our timestamping code makes and introduce interference of the<br />
graphics driver with visual stimulus onset timing. If you want to use<br />
your panel at a non-native resolution or orientation, leave it set at its<br />
native maximum settings and orientation and then use the panelfitter and<br />
display rotation functions of <a href="PsychImaging" class="uri">PsychImaging</a>(). See the demo<br />
<a href="PanelFitterDemo" class="uri">PanelFitterDemo</a>.m and its “help <a href="PanelFitterDemo" class="uri">PanelFitterDemo</a>” for further explanation<br />
on how to use the panelfitter.</p></li>
<li><p>System overload: Too many other applications are running in parallel<br />
to Psychtoolbox, introducing severe timing noise into the calibration and<br />
test loop. See ‘help SyncTrouble’ on what to do. This happens rather<br />
seldomly.</p></li>
<li><p>Driver bug: Not much you can do, except submit a bug report to Apple<br />
or Microsoft for your specific hardware + software setup. This is by far<br />
the most common cause of failure. Psychtoolbox tries to enable<br />
work-arounds for some common problems if possible. Usually you should<br />
update your graphics card driver to see if that resolves the problems.</p></li>
</ol>
<p>Note: As of Spring/Summer 2008, many graphics cards + driver combos from<br />
ATI and <a href="NVidia" class="uri">NVidia</a> on <a href="WindowsXP" class="uri">WindowsXP</a> have bugs which cause beamposition queries to<br />
fail in a peculiar way. If PTB detects that failure case, it will enable<br />
some workaround to keep the mechanism going at slightly reduced accuracy:<br />
Timestamps will still be mostly jitter-free and consistent, so they are<br />
fully useable for timestamping, timing checks and as a basis for timed<br />
stimulus presentation and animation. However, all returned timestamps<br />
will contain a constant bias wrt. the real stimulus onset time of<br />
somewhere between 20 microseconds and 1.5 milliseconds, depending on your<br />
display settings, because Psychtoolbox can’t determine the total height<br />
of your display in scanlines (including the invisible VBL interval)<br />
anymore. Exact height is important for spot-on timestamps. Psychtoolbox<br />
uses some safe, conservative value for its internal computations, so<br />
results will be consistent and useable, but contain a small constant<br />
offset.</p>
<p>In some rare cases, PTB’s automatic test fails to detect the bug and<br />
doesn’t enable the workaround by itself. You can manually enable the<br />
workaround if you want by adding the setting 4096<br />
(kPsychUseBeampositionQueryWorkaround) to the value x passed via:<br />
<a href="Screen" class="uri">Screen</a>(‘<a href="Preference" class="uri">Preference</a>’, ‘ConserveVRAM’, x);</p>
<p>Just insert this command at the top of your scripts before any other<br />
<a href="Screen" class="uri">Screen</a>() commands. ‘x’ must be at least 4096 or the sum of 4096 and any<br />
other values you may want to pass with that command. See “help<br />
<a href="ConserveVRAMSettings" class="uri">ConserveVRAMSettings</a>” for other workarounds that you can enable manually<br />
if needed.</p>
<p>If you want to get rid of that small offset, e.g., because you need to<br />
synchronize with other modalities or stimulation/recording equipment at<br />
sub-millisecond precisison, then you can try to figure out the real<br />
height of the display yourself and tell Psychtoolbox about the true value<br />
before calling <a href="Screen" class="uri">Screen</a>(‘OpenWindow’).</p>
<p>Once you know the real height, e.g., VTOTAL, you’d call this function:<br />
<a href="Screen" class="uri">Screen</a>(‘<a href="Preference" class="uri">Preference</a>’, ‘VBLEndlineOverride’, VTOTAL);</p>
<p>How to find out about VTOTAL? One way is to search the display control<br />
panel on Windows for some area with “Advanced Timing” or “Custom Timing”<br />
settings. The shareware utility “<a href="PowerStrip" class="uri">PowerStrip</a>” (http://www.entechtaiwan.com/util/ps.shtm)<br />
also allows to change and display these parameters in the Display<br />
Profiles -&gt; Configure -&gt; Advanced Timing -&gt; Vertical Geometry -&gt; “Total”<br />
field.</p>
<h3 id="accuracy-of-beamposition-method">Accuracy of beamposition method:</h3>
<p>Cross-checking of beamposition timestamps and kernel-level timestamps on<br />
a single display <a href="PowerPC" class="uri">PowerPC</a> G5 1.6 Ghz under OS-X 10.4.8 with <a href="NVidia" class="uri">NVidia</a><br />
<a href="GeforceFX" class="uri">GeforceFX</a>-5200 showed an accuracy of beamposition timestamping of better<br />
than 100 microseconds, with a maximum deviation between the different<br />
methods of less than 200 microseconds.</p>
<p>Initial checking on two Window PC’s (Dell Inspiron 8000 Laptop, Geforce<br />
2Go, Windows 2000, and some 3.2 Ghz Pentium-4 with <a href="NVidia" class="uri">NVidia</a> Geforce 7800<br />
GTX) shows a precision of about 30 microseconds. Multiple users performed<br />
similar testing procedures on their setups and confirmed the high<br />
accuracy and reliability for various <a href="MacOSX" class="uri">MacOSX</a> and Windows setups.</p>
<p>The results of systematic studies can be found in the <a href="PsychDocumentation" class="uri">PsychDocumentation</a>/<br />
subfolder in the file <a href="ECVP2010Poster" class="uri">ECVP2010Poster</a>_VisualTimingPrecision.pdf. They<br />
confirm the robustness and high precision of beamposition timestamping<br />
and especially of Linux’s builtin timestamping on a variety of tested<br />
hardware + operating system combinations in various system<br />
configurations. The pdf also provides further tips for precise visual<br />
onset timing.</p>
<p>Also check the FAQ section of http://www.psychtoolbox.org for latest<br />
infos.</p>
<div class="code_header" style="text-align:right;">
<p><span style="float:left;">Path  </span> <span class="counter">Retrieve <a href=
  "https://raw.github.com/Psychtoolbox-3/Psychtoolbox-3/beta/Psychtoolbox/PsychDocumentation/BeampositionQueries.m">current version from GitHub</a> | View <a href=
  "https://github.com/Psychtoolbox-3/Psychtoolbox-3/commits/beta/Psychtoolbox/PsychDocumentation/BeampositionQueries.m">changelog</a></span></p>
</div>
<div class="code">
<p><code>Psychtoolbox/PsychDocumentation/BeampositionQueries.m</code></p>
</div>
